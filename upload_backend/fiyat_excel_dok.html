<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>FiyatlarÄ± Excel DÃ–K</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial; background: #f9fafb; padding: 30px; }
    h2 { font-size: 24px; color: #1f2937; }
    .loader { display: none; border: 8px solid #f3f3f3; border-top: 8px solid #2563eb; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 20px auto; }
    @keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }
    .modal { display: none; position: fixed; top: 0; left: 0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    .modal-content { background: #fff; padding: 20px; border-radius: 8px; max-width: 90%; max-height: 90%; overflow:auto; }
    button { background: #2563eb; color: white; padding: 10px 20px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; margin:5px;}
    button:hover { background: #1d4ed8; }
    table { width:100%; border-collapse: collapse; margin-top:20px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; }
    th { background:#f1f5f9; }
    @media (max-width:600px){
      body{padding:10px;}
      h2{font-size:20px;}
      button{width:100%;}
      table, th, td{font-size:12px;}
    }
  </style>
</head>
<body>
  <h2>ðŸ“… FiyatlarÄ± Excel DÃ–K</h2>
  <button id="helpBtn">NasÄ±l Ã‡alÄ±ÅŸÄ±r?</button>
  <div class="modal" id="helpModal">
    <div class="modal-content">
      <h3>NasÄ±l Ã‡alÄ±ÅŸÄ±r?</h3>
      <p>1. Bir veya birden fazla resim/PDF seÃ§in.</p>
      <p>2. OCR dilini seÃ§in (TÃ¼rkÃ§e veya Ä°ngilizce).</p>
      <p>3. YÃ¼kle butonuna tÄ±klayÄ±n, algÄ±lanan verileri gÃ¶rÃ¼ntÃ¼leyin.</p>
      <p>4. DÃ¼zeltme gerekiyorsa tablo Ã¼zerinde dÃ¼zenleyin.</p>
      <p>5. 'Excel Ä°ndir' butonuna tÄ±klayarak sonucu alÄ±n.</p>
      <button id="closeModal">Kapat</button>
    </div>
  </div>

  <form id="uploadForm">
    <input type="file" name="files" accept="image/*,application/pdf" multiple required>
    <br>
    <label for="lang">Dil:</label>
    <select id="lang" name="lang">
      <option value="tur">TÃ¼rkÃ§e</option>
      <option value="eng">Ä°ngilizce</option>
    </select>
    <br>
    <button type="submit">YÃ¼kle</button>
  </form>

  <div class="loader" id="loader"></div>
  <div id="preview"></div>
  <button id="downloadBtn" style="display:none;">Excel Ä°ndir</button>

  <script>
    const helpBtn = document.getElementById('helpBtn');
    const helpModal = document.getElementById('helpModal');
    const closeModal = document.getElementById('closeModal');
    helpBtn.onclick = ()=> helpModal.style.display='flex';
    closeModal.onclick = ()=> helpModal.style.display='none';
    window.onclick = e=>{ if(e.target==helpModal) helpModal.style.display='none'; }

    const form = document.getElementById('uploadForm');
    const loader = document.getElementById('loader');
    const preview = document.getElementById('preview');
    const downloadBtn = document.getElementById('downloadBtn');
    let ocrData = [];

    form.addEventListener('submit', async function(e){
      e.preventDefault();
      loader.style.display='block';
      preview.innerHTML='';
      downloadBtn.style.display='none';

      const files = document.querySelector('input[name="files"]').files;
      const lang = document.getElementById('lang').value;
      const formData = new FormData();
      for(let file of files) formData.append('files', file);
      formData.append('lang', lang);

      const res = await fetch('/upload', {method:'POST', body: formData});
      ocrData = await res.json();
      loader.style.display='none';

      let html='<table><tr><th>KalkÄ±ÅŸ</th><th>VarÄ±ÅŸ</th><th>Fiyat</th><th>Tarih</th></tr>';
      ocrData.forEach(row=>{
        html+=`<tr>
          <td contenteditable="true">${row.kalkis}</td>
          <td contenteditable="true">${row.varis}</td>
          <td contenteditable="true">${row.fiyat}</td>
          <td>${row.tarih}</td>
        </tr>`;
      });
      html+='</table>';
      preview.innerHTML=html;
      downloadBtn.style.display='inline-block';
    });

    downloadBtn.addEventListener('click', async ()=>{
      const tableRows = preview.querySelectorAll('table tr');
      const data = [];
      tableRows.forEach((tr,i)=>{
        if(i===0) return;
        const cells = tr.querySelectorAll('td');
        data.push({kalkis:cells[0].innerText.trim(), varis:cells[1].innerText.trim(), fiyat:cells[2].innerText.trim()});
      });
      const res = await fetch('/generate', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({data})
      });
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href=url; a.download='Fiyat_Talep_Sonuclu.xlsx';
      a.click();
    });
  </script>
</body>
</html>
